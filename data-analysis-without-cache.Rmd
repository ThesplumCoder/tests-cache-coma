---
title: "Análisis de Datos de Rendimiento sin Cache"
author: "Anderson Acuña"
date: "2024-12-15"
output: 
  html_document: 
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Extracción de datos

La carga de datos se hace desde el archivo exportado por **DBeaver**, para la 
tabla *events_statements_summary_by_digest* en la base de datos 
*performance_schema*.
```{r}
data_perf_schema <- read.csv(file = "./data/events_statements_summary_by_digest_202412151135.csv")

schema_split <- strsplit(data_perf_schema$SCHEMA_NAME, split = "_")
data_perf_schema$STRUCTURE_BD <- unlist(lapply(schema_split, function(x) { x[1] }))
data_perf_schema <- data_perf_schema[, c("STRUCTURE_BD", setdiff(names(data_perf_schema), "STRUCTURE_BD"))]
data_perf_schema$SCHOOL <- unlist(lapply(schema_split, function(x) { x[2] }))
data_perf_schema <- data_perf_schema[, c("SCHOOL", setdiff(names(data_perf_schema), "SCHOOL"))]
```

Se hace la validación de significancia de los datos recolectados por el 
*performance_schema*. Para este fin se observa cuánto porcentaje corresponde al 
registro especial, caracterizado por `SCHEMA_NAME = NULL` y `DIGEST = NULL`.
```{r}
total_count <- sum(data_perf_schema$COUNT_STAR)
special_row <- subset(data_perf_schema, SCHEMA_NAME == "" & DIGEST == "")
other_statements <- subset(data_perf_schema, DIGEST != "")

row_categories <- matrix(c(special_row$COUNT_STAR, sum(other_statements$COUNT_STAR)) / total_count, 
                         ncol = 2)
colnames(row_categories) <- c("Registro especial", "Otras sentencias")

barplot(row_categories, 
        ylim = c(0, 1), 
        col = c("dodgerblue", "red"), 
        main = "Validación de significancia", 
        ylab = "Porcentaje")
```

Se seleccionan los registros que se relacionan con consultas, es decir, los que 
en la columna `DIGEST_TEXT` contengan la palabra clave `SELECT`.
```{r}
queries_data <- data_perf_schema[grepl("SELECT", data_perf_schema$DIGEST_TEXT), ]
```


# Exploración de datos

Se observa la participación de cada escuela en la muestra.
```{r}
diamond_queries <- queries_data[queries_data$STRUCTURE_BD == "diamante", ]
division_queries <- queries_data[queries_data$STRUCTURE_BD == "division", ]

barplot(sort(table(queries_data$SCHOOL), decreasing = TRUE), 
        las = 2, 
        col = "coral", 
        main = "Consultas a bases de datos", 
        xlab = "Escuela", 
        ylab = "Cantidad")
barplot(sort(table(diamond_queries$SCHOOL), decreasing = TRUE), 
        las = 2, 
        col = "dodgerblue", 
        main = "Consultas a BDs Diamante", 
        xlab = "Escuela", 
        ylab = "Cantidad")
barplot(sort(table(division_queries$SCHOOL), decreasing = TRUE), 
        las = 2, 
        col = "orange", 
        main = "Consultas a BDs División", 
        xlab = "Escuela", 
        ylab = "Cantidad")
```


Ordenamos los datos en forma descendente para los valores de **Tiempo de espera 
promedio** (`AVG_TIMER_WAIT`) y **Conteo de veces** (`COUNT_STAR`).
```{r}
ordered_count_star <- queries_data[order(queries_data$COUNT_STAR, 
                                         decreasing = TRUE), ]
ordered_avg_timer_wait <- queries_data[order(queries_data$AVG_TIMER_WAIT, 
                                             decreasing = TRUE), ]
# Remove duplicates.
unique_count_star <- ordered_count_star[!duplicated(ordered_count_star$DIGEST), ]
unique_avg_timer_wait <- ordered_avg_timer_wait[!duplicated(ordered_avg_timer_wait$DIGEST), ]

# TOP
top <- queries_data[intersect(rownames(unique_count_star[1:1000, ]), rownames(unique_avg_timer_wait[1:1000, ])), ]
```

Exploramos cada columna de interés para observar sus parámetros estadísticos.
```{r}
hist(top$AVG_TIMER_WAIT)
boxplot(top$AVG_TIMER_WAIT, 
        outline = FALSE, 
        horizontal = TRUE)

hist(top$COUNT_STAR)
boxplot(top$COUNT_STAR, 
        outline = FALSE, 
        horizontal = TRUE)

hist(top$SUM_ROWS_SENT / top$COUNT_STAR)
boxplot(top$SUM_ROWS_SENT / top$COUNT_STAR, 
        outline = FALSE, 
        horizontal = TRUE)
```

## Análisis individual de las consultas

```{r}
queries_tbmenu_prod <- read.csv(file = "./data/events_statements_history_long_202412181352.csv")
queries_tbmenu_local <- read.csv(file = "./data/events_statements_history_long_202412181703.csv")
```

```{r}
hist(queries_tbmenu_prod$TIMER_WAIT, 
     breaks = 10)
hist(queries_tbmenu_local$TIMER_WAIT, 
     breaks = 10)

par(mfrow = c(1, 2))
boxplot(queries_tbmenu_prod$TIMER_WAIT)
boxplot(queries_tbmenu_local$TIMER_WAIT)
```


